<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å†™æ–‡ç«  â€” Markdown ç¼–è¾‘å™¨</title>
  <style>
    :root{--bg1:#071026;--bg2:#061027;--surface:#071026;--text:#e6eef8;--muted:#94a3b8;--accent:#60a5fa;--card-border:rgba(255,255,255,0.03)}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);transition:background-color .25s,color .25s}
    body.light{--bg1:#f5f7fb;--bg2:#fff;--surface:#fff;--text:#0b1220;--muted:#6b7280;--accent:#2563eb;--card-border:rgba(2,6,23,0.06)}
    .wrap{max-width:1100px;margin:20px auto;display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
    .panel{background:var(--surface);padding:12px;border-radius:8px;border:1px solid var(--card-border)}
    input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid var(--card-border);background:transparent;color:inherit}
    textarea{height:420px;font-family:ui-monospace,monospace}
    .row{display:flex;gap:8px;margin-bottom:8px}
    .btn{background:var(--surface);padding:8px 12px;border-radius:8px;color:var(--text);text-decoration:none;border:1px solid var(--card-border);cursor:pointer}
    .muted{color:var(--muted)}
    @media(max-width:900px){.wrap{grid-template-columns:1fr}}
    .theme-toggle{position:fixed;right:14px;top:14px;background:var(--surface);color:var(--text);border:1px solid var(--card-border);padding:8px;border-radius:8px;cursor:pointer}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="row"><input id="title" placeholder="æ–‡ç« æ ‡é¢˜"></div>
      <div class="row"><input id="tags" placeholder="æ ‡ç­¾ï¼Œé€—å·åˆ†éš”"></div>
      <textarea id="md" placeholder="# åœ¨è¿™é‡Œå†™ Markdown"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="download">ä¸‹è½½ .md</button>
        <button class="btn" id="copyHtml">å¤åˆ¶ HTML</button>
      </div>
      <p class="muted">è¯´æ˜ï¼šæ­¤ç¼–è¾‘å™¨æ”¯æŒæœ¬åœ°å¯¼å‡º Markdownã€‚è¦ç›´æ¥å‘å¸ƒåˆ° GitHubï¼Œå¯ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆPATï¼‰ï¼Œä½†è¯·è°¨æ…å¤„ç†ã€‚</p>

      <div style="margin-top:12px;border-top:1px dashed var(--card-border);padding-top:12px">
        <div style="margin-bottom:8px;color:var(--muted)">å¯é€‰ï¼šç›´æ¥å‘å¸ƒåˆ° GitHubï¼ˆä¼šåœ¨ç›®æ ‡ä»“åº“åˆ›å»º/æ›´æ–° posts/*.md å¹¶ä¿®æ”¹ posts/index.jsonï¼‰ã€‚</div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="ghOwner" placeholder="ownerï¼ˆä¾‹å¦‚ yunli2024ï¼‰" value="yunli2024" style="width:160px">
          <input id="ghRepo" placeholder="repoï¼ˆä¾‹å¦‚ yunli2024.github.ioï¼‰" value="yunli2024.github.io" style="width:220px">
          <input id="ghBranch" placeholder="branchï¼ˆä¾‹å¦‚ mainï¼‰" value="main" style="width:120px">
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="ghToken" placeholder="GitHub Personal Access Token (å†™å…¥æƒé™)" type="password" style="flex:1">
          <button class="btn" id="publishBtn">å‘å¸ƒåˆ° GitHub</button>
        </div>
        <div style="color:var(--muted);font-size:13px">æ³¨æ„ï¼šåœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆPATï¼‰æœ‰å®‰å…¨é£é™©ã€‚è¯·ä»…åœ¨å¯ä¿¡ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚</div>
      </div>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>å®æ—¶é¢„è§ˆ</strong><a href="posts/" class="muted">/posts/</a></div>
      <div id="preview" style="overflow:auto;height:520px;padding:6px;background:#041025;border-radius:6px"></div>
    </div>
  </div>

  <script>
    const mdEl = document.getElementById('md');
    const prev = document.getElementById('preview');
    const titleEl = document.getElementById('title');
    const tagsEl = document.getElementById('tags');
    function render(){prev.innerHTML = marked.parse(mdEl.value||'');}
    mdEl.addEventListener('input', render); titleEl.addEventListener('input', ()=>{});
    render();

    document.getElementById('download').addEventListener('click', ()=>{
      const title = (titleEl.value||'untitled').trim();
      const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||'post';
      const filename = `posts/${slug}.md`;
      const front = `---\ntitle: ${title}\ndate: ${new Date().toISOString()}\ntags: [${tagsEl.value}]\n---\n\n`;
      const blob = new Blob([front + mdEl.value], {type:'text/markdown;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('copyHtml').addEventListener('click', async ()=>{
      const html = marked.parse(mdEl.value||'');
      try{await navigator.clipboard.writeText(html); alert('å·²å¤åˆ¶ HTML åˆ°å‰ªè´´æ¿');}catch(e){alert('å¤åˆ¶å¤±è´¥ï¼š'+e)}
    });

    // --- GitHub publish logic ---
    function toBase64Unicode(str){return btoa(unescape(encodeURIComponent(str)))}
    function fromBase64Unicode(b64){return decodeURIComponent(escape(atob(b64)))}

    async function ghGet(path, owner, repo, branch, token){
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
      const res = await fetch(url, {headers: token ? {Authorization: 'token '+token} : {}});
      if(res.status === 404) return null;
      if(!res.ok) throw new Error('GET Failed '+res.status);
      return await res.json();
    }

    async function ghPut(path, owner, repo, branch, token, contentStr, message, sha){
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const body = {message: message || `Add ${path}`, content: toBase64Unicode(contentStr), branch};
      if(sha) body.sha = sha;
      const res = await fetch(url, {method:'PUT', headers:{Authorization: 'token '+token,'Content-Type':'application/json'}, body: JSON.stringify(body)});
      if(!res.ok) throw new Error('PUT Failed '+res.status);
      return await res.json();
    }

    document.getElementById('publishBtn').addEventListener('click', async ()=>{
      const owner = document.getElementById('ghOwner').value.trim();
      const repo = document.getElementById('ghRepo').value.trim();
      const branch = document.getElementById('ghBranch').value.trim() || 'main';
      const token = document.getElementById('ghToken').value.trim();
      if(!owner || !repo){alert('è¯·å¡«å†™ owner ä¸ repo');return}
      if(!token){ if(!confirm('æœªæä¾› PATï¼Œæ— æ³•ç›´æ¥æ¨é€ã€‚è¦ç»§ç»­ä»…ä¸‹è½½è¯·ç‚¹å‡»å–æ¶ˆã€‚')) return }

      const title = (titleEl.value||'untitled').trim();
      const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('post-'+Date.now());
      const path = `posts/${slug}.md`;
      const front = `---\ntitle: ${title}\ndate: ${new Date().toISOString()}\ntags: [${tagsEl.value}]\n---\n\n`;
      const mdContent = front + mdEl.value;

      try{
        // create or update the markdown file
        const existing = await ghGet(path, owner, repo, branch, token);
        const sha = existing ? existing.sha : undefined;
        await ghPut(path, owner, repo, branch, token, mdContent, `Publish ${slug}.md`, sha);

        // update posts/index.json
        const idxPath = 'posts/index.json';
        let idxObj = [];
        const idxExisting = await ghGet(idxPath, owner, repo, branch, token);
        if(idxExisting && idxExisting.content){
          try{ idxObj = JSON.parse(fromBase64Unicode(idxExisting.content)); }catch(e){ idxObj = [] }
        }
        // add new entry at front
        const entry = {file: path, title: title, date: (new Date()).toISOString().slice(0,10), tags: (tagsEl.value||'').split(',').map(s=>s.trim()).filter(Boolean).join(','), excerpt: (mdEl.value||'').slice(0,140)};
        // remove existing same file if present
        idxObj = idxObj.filter(it=>it.file !== path);
        idxObj.unshift(entry);
        // put back
        const idxSha = idxExisting ? idxExisting.sha : undefined;
        await ghPut(idxPath, owner, repo, branch, token, JSON.stringify(idxObj, null, 2), `Update posts/index.json (add ${slug})`, idxSha);

        alert('å·²å‘å¸ƒåˆ° GitHubï¼š' + owner + '/' + repo + ' @ ' + branch);
      }catch(e){
        console.error(e);
        alert('å‘å¸ƒå¤±è´¥ï¼š'+e.message);
      }
    });
  </script>
  <button id="globalThemeBtn" class="theme-toggle" title="åˆ‡æ¢æ—¥/å¤œæ¨¡å¼">ğŸŒ™</button>
  <script>
    const gBtn = document.getElementById('globalThemeBtn');
    function applyThemePage(t){ if(t==='light') document.body.classList.add('light'); else document.body.classList.remove('light'); gBtn.textContent = document.body.classList.contains('light') ? 'â˜€ï¸' : 'ğŸŒ™'; try{localStorage.setItem('site-theme', t)}catch(e){} }
    (function(){ let t='dark'; try{const s=localStorage.getItem('site-theme'); if(s) t=s;}catch(e){} applyThemePage(t); gBtn.addEventListener('click', ()=>{const cur=document.body.classList.contains('light')?'light':'dark'; applyThemePage(cur==='light'?'dark':'light');}); })();
  </script>
</body>
</html>
