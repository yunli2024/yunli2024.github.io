<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å†™æ–‡ç«  â€” Markdown ç¼–è¾‘å™¨</title>
  <style>
    :root{--bg1:#071026;--bg2:#061027;--surface:#071026;--text:#e6eef8;--muted:#94a3b8;--accent:#60a5fa;--card-border:rgba(255,255,255,0.03)}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);transition:background-color .25s,color .25s}
    body.light{--bg1:#f5f7fb;--bg2:#fff;--surface:#fff;--text:#0b1220;--muted:#6b7280;--accent:#2563eb;--card-border:rgba(2,6,23,0.06)}
    .wrap{max-width:1100px;margin:20px auto;display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
    .panel{background:var(--surface);padding:12px;border-radius:8px;border:1px solid var(--card-border)}
    input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid var(--card-border);background:transparent;color:inherit}
    textarea{height:420px;font-family:ui-monospace,monospace}
    .row{display:flex;gap:8px;margin-bottom:8px}
    .btn{background:var(--surface);padding:8px 12px;border-radius:8px;color:var(--text);text-decoration:none;border:1px solid var(--card-border);cursor:pointer}
    .muted{color:var(--muted)}
    @media(max-width:900px){.wrap{grid-template-columns:1fr}}
    .theme-toggle{position:fixed;right:14px;top:14px;background:var(--surface);color:var(--text);border:1px solid var(--card-border);padding:8px;border-radius:8px;cursor:pointer}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="row"><input id="title" placeholder="æ–‡ç« æ ‡é¢˜"></div>
      <div class="row"><input id="tags" placeholder="æ ‡ç­¾ï¼Œé€—å·åˆ†éš”"></div>
      <textarea id="md" placeholder="# åœ¨è¿™é‡Œå†™ Markdown"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="download">ä¸‹è½½ .md</button>
        <button class="btn" id="copyHtml">å¤åˆ¶ HTML</button>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <input id="existingIndex" type="file" accept="application/json" title="å¯é€‰ï¼šä¸Šä¼ å½“å‰ posts/index.json ä»¥åˆå¹¶">
        <button class="btn" id="downloadAll">ä¸‹è½½ MD å¹¶ç”Ÿæˆ index.json</button>
      </div>
      <p class="muted">è¯´æ˜ï¼šæ­¤ç¼–è¾‘å™¨ä»…æ”¯æŒæœ¬åœ°å¯¼å‡º Markdownï¼ˆä¸‹è½½ .md å¹¶æ‰‹åŠ¨ä¸Šä¼ åˆ°ä»“åº“ï¼‰ã€‚</p>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>å®æ—¶é¢„è§ˆ</strong><a href="posts/" class="muted">/posts/</a></div>
      <div id="preview" style="overflow:auto;height:520px;padding:6px;background:#041025;border-radius:6px"></div>
    </div>
  </div>

  <script>
    const mdEl = document.getElementById('md');
    const prev = document.getElementById('preview');
    const titleEl = document.getElementById('title');
    const tagsEl = document.getElementById('tags');
    function render(){prev.innerHTML = marked.parse(mdEl.value||'');}
    mdEl.addEventListener('input', render); titleEl.addEventListener('input', ()=>{});
    render();

    document.getElementById('download').addEventListener('click', ()=>{
      const title = (titleEl.value||'untitled').trim();
      const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||'post';
      const filename = `posts/${slug}.md`;
      const front = `---\ntitle: ${title}\ndate: ${new Date().toISOString()}\ntags: [${tagsEl.value}]\n---\n\n`;
      const blob = new Blob([front + mdEl.value], {type:'text/markdown;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('copyHtml').addEventListener('click', async ()=>{
      const html = marked.parse(mdEl.value||'');
      try{await navigator.clipboard.writeText(html); alert('å·²å¤åˆ¶ HTML åˆ°å‰ªè´´æ¿');}catch(e){alert('å¤åˆ¶å¤±è´¥ï¼š'+e)}
    });

    // ä¸‹è½½ MD å¹¶ç”Ÿæˆ/åˆå¹¶ index.jsonï¼ˆæœ¬åœ°ä¸‹è½½ï¼Œç”¨äºæ‰‹åŠ¨ pushï¼‰
    document.getElementById('downloadAll').addEventListener('click', async ()=>{
      const title = (titleEl.value||'untitled').trim();
      const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')||('post-'+Date.now());
      const path = `posts/${slug}.md`;
      const front = `---\ntitle: ${title}\ndate: ${new Date().toISOString()}\ntags: [${tagsEl.value}]\n---\n\n`;
      const mdContent = front + mdEl.value;

      // è¯»å–å¯é€‰çš„ç°æœ‰ index.json
      const input = document.getElementById('existingIndex');
      let idxArr = [];
      if(input && input.files && input.files.length>0){
        try{
          const txt = await input.files[0].text();
          const parsed = JSON.parse(txt);
          if(Array.isArray(parsed)) idxArr = parsed;
        }catch(e){alert('è¯»å–ä¸Šä¼ çš„ index.json å¤±è´¥ï¼Œå°†ç”Ÿæˆæ–°çš„ index.json')}
      }

      // åˆ›å»ºæ¡ç›®å¹¶åˆå¹¶ï¼ˆå»é‡åç½®é¦–ä½ï¼‰
      const entry = {file: path, title: title, date: (new Date()).toISOString().slice(0,10), tags: (tagsEl.value||'').split(',').map(s=>s.trim()).filter(Boolean).join(','), excerpt: (mdEl.value||'').slice(0,140)};
      idxArr = idxArr.filter(it=>it.file !== path);
      idxArr.unshift(entry);

      // è§¦å‘ä¸¤ä¸ªæ–‡ä»¶çš„ä¸‹è½½ï¼šmd ä¸ index.json
      const mdBlob = new Blob([mdContent], {type:'text/markdown;charset=utf-8'});
      const mdUrl = URL.createObjectURL(mdBlob);
      const a1 = document.createElement('a'); a1.href = mdUrl; a1.download = path; document.body.appendChild(a1); a1.click(); a1.remove(); URL.revokeObjectURL(mdUrl);

      const jsonBlob = new Blob([JSON.stringify(idxArr, null, 2)], {type:'application/json;charset=utf-8'});
      const jUrl = URL.createObjectURL(jsonBlob);
      const a2 = document.createElement('a'); a2.href = jUrl; a2.download = 'posts/index.json'; document.body.appendChild(a2); a2.click(); a2.remove(); URL.revokeObjectURL(jUrl);

      alert('å·²ç”Ÿæˆå¹¶ä¸‹è½½ï¼š' + path + 'ï¼Œä»¥åŠ posts/index.jsonã€‚è¯·å°†å®ƒä»¬æ”¾åˆ°ä»“åº“å¹¶ pushã€‚');
    });

    
  </script>
  <button id="globalThemeBtn" class="theme-toggle" title="åˆ‡æ¢æ—¥/å¤œæ¨¡å¼">ğŸŒ™</button>
  <script>
    const gBtn = document.getElementById('globalThemeBtn');
    function applyThemePage(t){ if(t==='light') document.body.classList.add('light'); else document.body.classList.remove('light'); gBtn.textContent = document.body.classList.contains('light') ? 'â˜€ï¸' : 'ğŸŒ™'; try{localStorage.setItem('site-theme', t)}catch(e){} }
    (function(){ let t='dark'; try{const s=localStorage.getItem('site-theme'); if(s) t=s;}catch(e){} applyThemePage(t); gBtn.addEventListener('click', ()=>{const cur=document.body.classList.contains('light')?'light':'dark'; applyThemePage(cur==='light'?'dark':'light');}); })();
  </script>
</body>
</html>
<!-- é¼ æ ‡ç‚¹å‡»çˆ±å¿ƒç‰¹æ•ˆ -->
<script>
!function(e,t,a){function r(){for(var e=0;e<s.length;e++)s[e].alpha<=0?(t.body.removeChild(s[e].el),s.splice(e,1)):(s[e].y--,s[e].scale+=.004,s[e].alpha-=.013,s[e].el.style.cssText="left:"+s[e].x+"px;top:"+s[e].y+"px;opacity:"+s[e].alpha+";transform:scale("+s[e].scale+","+s[e].scale+") rotate(45deg);background:"+s[e].color+";z-index:99999");requestAnimationFrame(r)}function n(){var t="function"==typeof e.onclick&&e.onclick;e.onclick=function(e){t&&t(),o(e)}}function o(e){var a=t.createElement("div");a.className="heart",s.push({el:a,x:e.clientX-5,y:e.clientY-5,scale:1,alpha:1,color:c()}),t.body.appendChild(a)}function i(e){var a=t.createElement("style");a.type="text/css";try{a.appendChild(t.createTextNode(e))}catch(t){a.styleSheet.cssText=e}t.getElementsByTagName("head")[0].appendChild(a)}function c(){return"rgb("+~~(255*Math.random())+","+~~(255*Math.random())+","+~~(255*Math.random())+")"}var s=[];e.requestAnimationFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"),n(),r()}(window,document);
</script>
